---
- name: Include private vars
  include_role:
    name: ops_roles/include_private_vars

- name: Create temp directory to store the template
  command: mktemp -d /tmp/openshift-logging-ansible-XXXXXX
  register: mktemp
  changed_when: False

- set_fact:
    tempdir: "{{ mktemp.stdout }}"

- name: "create project for {{ oii_namespace }}"
  oadm_project:
    name: "{{ oii_namespace }}"
    display_name: "{{ oii_namespace }}"
    description: ClamAV Scanning Service
  retries: 12
  delay: 5

- name: create imageinspector serviceaccount
  oc_serviceaccount:
    name: imageinspector
    namespace: image-inspector

- name: set service account permissions
  oadm_policy_user:
    namespace: image-inspector
    user: system:serviceaccount:image-inspector:imageinspector
    resource_kind: "{{ item.r_kind }}" 
    resource_name: "{{ item.r_name }}"
    state: present
  with_items:
    - r_kind: cluster-role
      r_name: cluster-reader
    - r_kind: scc
      r_name: privileged

- name: copy image inspector template
  copy:
    src: image-inspector.yml
    dest: "{{ tempdir }}/image-inspector.yml"

- name: "Check to see if template already exists in {{ oii_namespace }}"
  oc_obj:
    state: list
    namespace: "{{ oii_namespace }}"
    kind: templates
  register: templatelist

- debug:
    msg: "{{ item['results']['results'][0]['kind'] }}"
  with_items:
  - "{{ templatelist }}"

#- name: Set image inspector template
#  oc_obj:
#    kind: template
#    name: image-inspector
#    namespace: "{{ oii_namespace }}" 
#    state: present
#    files: "{{ tempdir }}/image-inspector.yml"
#    debug: true
#    force: true
#    delete_after: true
#  when:  templatelist['results']['results'][0]['items'] | length < 1

- name: "Create bc,is,ds for apps in {{ oii_namespace }} from template"
  oc_process:
    namespace: "{{ oii_namespace }}"
    template_name: oso-image-inspector
    content: "{{ lookup('file', 'files/image-inspector.yml') }}"
    create: True
    debug: True
    params:
      PLAT: rhel7
  register: processout
  run_once: true

- debug: var=processout

#
#- name: Create base bc 
#  oc_obj:
#    state: present
#    kind: bc
#    name: "oso-rhel7-ops-base"
#    files:
#    - "{{ tempdir }}/image-inspector.yml"
#
#- name: Deploy image inspector pods
#  oc_process:
#    namespace: "{{ oii_namespace }}"
#    template_name: "oso-image-inspector"
#    create: True
#    debug: True
#    params:
#      PLAT: "rhel7"

- name: Delete temp directory
  file:
    name: "{{ tempdir }}"
    state: absent
